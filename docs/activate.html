###############################################################
# TRIAL ACTIVATION (Influencer/Demo Access)
###############################################################

import json
from datetime import datetime, timedelta
from pathlib import Path

TRIALS_FILE = "/home/paulroberts/fusion_api/trials.json"

class TrialActivateRequest(BaseModel):
    tv_username: str
    trial_days: int = 14
    influencer: str = "direct"

def load_trials():
    if Path(TRIALS_FILE).exists():
        with open(TRIALS_FILE, 'r') as f:
            return json.load(f)
    return []

def save_trials(trials):
    with open(TRIALS_FILE, 'w') as f:
        json.dump(trials, f, indent=2)

@app.post("/trial-activate")
async def trial_activate(payload: TrialActivateRequest):
    try:
        logger.info(f"Trial activation: {payload.tv_username}, {payload.trial_days} days, influencer={payload.influencer}")
        
        # Grant all 6 indicators
        client = TradingViewClient()
        all_indicators = ["FusionFlex", "FusionTrend", "FusionConfluence", "FusionReversal", "FusionScorer", "FusionPredict-MTF"]
        
        results = []
        for indicator in all_indicators:
            result = client.grant_access(payload.tv_username, indicator)
            results.append(result)
            status = "✓" if result['success'] else "✗"
            logger.info(f"  {status} {indicator}: {result.get('status', result.get('error', 'failed'))}")
        
        # Calculate expiration date
        expiration = (datetime.utcnow() + timedelta(days=payload.trial_days)).isoformat()
        
        # Save trial record
        trials = load_trials()
        trials.append({
            "tv_username": payload.tv_username,
            "influencer": payload.influencer,
            "trial_days": payload.trial_days,
            "granted_at": datetime.utcnow().isoformat(),
            "expires_at": expiration,
            "indicators": all_indicators,
            "revoked": False
        })
        save_trials(trials)
        
        all_success = all(r['success'] for r in results)
        if all_success:
            logger.info(f"✅ Trial activated: {payload.tv_username} expires {expiration}")
            return {"success": True, "expires_at": expiration}
        else:
            failed = [r['script'] for r in results if not r['success']]
            raise HTTPException(status_code=500, detail=f"Some indicators failed: {failed}")
            
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"Trial activation error: {e}")
        raise HTTPException(status_code=500, detail
