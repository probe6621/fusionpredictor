<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Activate Trial - FusionPredictor</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --cyan: #00E7F7;
      --cyan-soft: rgba(0, 231, 247, 0.25);
      --cyan-glow: rgba(0, 231, 247, 0.45);
      --dark-bg: #0A0E1A;
      --card-bg: #131827;
      --pill-bg: #0F1323;
      --pill-border: rgba(0, 231, 247, 0.25);
      --text-primary: #FFFFFF;
      --text-secondary: #A0AEC0;
      --error-red: #ff6b6b;
      --ok-green: #39d98a;
    }

    body {
      background: var(--dark-bg);
      font-family: 'Inter', sans-serif;
      padding: 2rem;
      color: var(--text-primary);
    }

    .activation-container {
      max-width: 620px;
      margin: 4rem auto;
      background: var(--card-bg);
      padding: 2.5rem;
      border-radius: 16px;
      border: 1px solid rgba(0, 231, 247, 0.15);
      box-shadow: 0 0 40px rgba(0, 231, 247, 0.05);
    }

    h1 {
      text-align: center;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 2rem;
      margin-bottom: 0.75rem;
      background: linear-gradient(135deg, #ffffff, var(--cyan));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .subtitle {
      text-align: center;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
      line-height: 1.5;
    }

    .trial-banner {
      text-align: center;
      margin: 0 auto 2rem auto;
      font-size: 0.95rem;
      line-height: 1.6;
      color: var(--text-secondary);
      padding: 0.9rem 1rem;
      border-radius: 12px;
      background: rgba(0, 231, 247, 0.08);
      border: 1px solid rgba(0, 231, 247, 0.18);
    }

    .trial-banner strong { color: var(--cyan); font-weight: 700; }

    form {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    label {
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: block;
      color: #dfe7f3;
    }

    input {
      width: 100%;
      padding: 1rem;
      background: var(--pill-bg);
      border: 1px solid var(--pill-border);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 1rem;
      outline: none;
    }

    input:focus {
      border-color: rgba(0, 231, 247, 0.55);
      box-shadow: 0 0 0 4px rgba(0, 231, 247, 0.10);
    }

    .hint {
      margin-top: -0.75rem;
      color: var(--text-secondary);
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .submit-btn {
      width: 100%;
      padding: 1rem;
      background: var(--cyan);
      color: var(--dark-bg);
      font-weight: 800;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.05rem;
      border: none;
      transition: transform 0.08s ease;
    }

    .submit-btn:active { transform: scale(0.99); }

    .success-box, .error-box {
      display: none;
      margin-top: 1.5rem;
      padding: 1.1rem 1.2rem;
      border-radius: 12px;
      text-align: center;
      font-weight: 650;
      line-height: 1.5;
    }

    .success-box {
      background: rgba(57, 217, 138, 0.12);
      color: var(--ok-green);
      border: 1px solid rgba(57, 217, 138, 0.25);
    }

    .error-box {
      background: rgba(255, 100, 100, 0.12);
      color: var(--error-red);
      border: 1px solid rgba(255, 100, 100, 0.22);
    }

    .tiny {
      margin-top: 1rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
      text-align: center;
      line-height: 1.45;
    }

    .tiny code {
      color: #dbe7ff;
      background: rgba(255,255,255,0.06);
      padding: 0.12rem 0.3rem;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.08);
    }
  </style>
</head>

<body>

<script>
  // Cookie helpers
  function setCookie(name, value, days) {
    const expires = new Date(Date.now() + days * 864e5).toUTCString();
    document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/; SameSite=Lax`;
  }
  function getCookie(name) {
    return document.cookie
      .split('; ')
      .find(row => row.startsWith(name + '='))
      ?.split('=')[1];
  }

  // Read URL params
  const params = new URLSearchParams(window.location.search);

  // Support: ?trial=14
  const trialDays = parseInt(params.get("trial") || "14", 10);

  // Support: ?influencer=Arun (or default "direct")
  const influencer = (params.get("influencer") || "direct").trim();

  // Support: ?via=fusion (Rewardful "via")
  const via = params.get("via");

  // Persist attribution cookies (90 days)
  if (via) setCookie("rewardful_via", via, 90);
  if (influencer) setCookie("fusion_influencer", influencer, 90);

  // Put into page after load
  window.__FUSION_TRIAL__ = { trialDays, influencer, via };
</script>

<div class="activation-container">
  <h1>Activate Your Trial</h1>

  <p class="subtitle">
    Enter your TradingView username to unlock your invite-only indicators.
  </p>

  <div class="trial-banner" id="trialBanner">
    <strong>14-day full access trial.</strong><br/>
    Courtesy of our partner <strong>direct</strong>.
  </div>

  <form id="trialForm">
    <div>
      <label>TradingView Username</label>
      <input type="text" id="tv" required placeholder="Your TradingView username" autocomplete="off" />
      <div class="hint">Make sure this matches your TradingView username exactly.</div>
    </div>

    <button type="submit" class="submit-btn" id="submitBtn">Activate My Trial</button>
  </form>

  <div class="success-box" id="successBox">
    ✅ Trial activation submitted!<br/>
    Your indicators will be enabled within <strong>5–10 minutes</strong>.
  </div>

  <div class="error-box" id="errorBox">
    ❌ <span id="errorText">Something went wrong. Please try again.</span>
  </div>

  <div class="tiny">
    Endpoint: <code>POST https://api.fusionpredictor.com/trial-activate</code>
  </div>
</div>

<script>
  // Paint banner from params/cookies
  (function initBanner(){
    const trial = window.__FUSION_TRIAL__?.trialDays ?? 14;
    const infl = window.__FUSION_TRIAL__?.influencer ?? (getCookie("fusion_influencer") || "direct");
    const banner = document.getElementById("trialBanner");
    banner.innerHTML = `
      <strong>${trial}-day full access trial.</strong><br/>
      Courtesy of our partner <strong>${escapeHtml(infl)}</strong>.
    `;
  })();

  function escapeHtml(str) {
    return (str || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  const form = document.getElementById("trialForm");
  const successBox = document.getElementById("successBox");
  const errorBox = document.getElementById("errorBox");
  const errorText = document.getElementById("errorText");
  const submitBtn = document.getElementById("submitBtn");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    successBox.style.display = "none";
    errorBox.style.display = "none";

    const tvUsernameRaw = document.getElementById("tv").value || "";
    const tvUsername = tvUsernameRaw.trim();

    if (!tvUsername) return;

    const trialDays = window.__FUSION_TRIAL__?.trialDays ?? 14;

    // influencer: URL param takes priority, else cookie, else direct
    const influencer =
      (window.__FUSION_TRIAL__?.influencer || "").trim() ||
      decodeURIComponent(getCookie("fusion_influencer") || "") ||
      "direct";

    const payload = {
      tv_username: tvUsername,
      trial_days: trialDays,
      influencer: influencer
    };

    try {
      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting...";

      const res = await fetch("https://api.fusionpredictor.com/trial-activate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(() => ({}));

      if (res.ok) {
        successBox.style.display = "block";
        errorBox.style.display = "none";
      } else {
        // If backend returns a friendly detail, show it (like duplicate trial)
        const msg = data?.detail || "Something went wrong. Please try again.";
        errorText.textContent = msg;
        errorBox.style.display = "block";
        successBox.style.display = "none";
      }
    } catch (err) {
      errorText.textContent = "Network error. Please try again.";
      errorBox.style.display = "block";
      successBox.style.display = "none";
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Activate My Trial";
    }
  });
</script>

</body>
</html>
